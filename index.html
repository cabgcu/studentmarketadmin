<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>CAB Student Market Admin</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-dark: #000000;
            --glass-surface: rgba(15, 15, 15, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --gradient-accent: linear-gradient(135deg, #0A84FF, #BF5AF2);
            --gradient-success: linear-gradient(135deg, #34C759, #30B0C7);
            --gradient-danger: linear-gradient(135deg, #FF3B30, #FF9500);
            --gradient-warning: linear-gradient(135deg, #FF9500, #FFCC00);
            
            --radius-card: 28px;
            --radius-input: 20px;
            --radius-button: 100px;
            --blur: 40px;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            font-family: var(--font-stack);
            color: var(--text-main);
            background-color: transparent;
            min-height: 100vh;
            padding-bottom: 40px;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        #bg-container { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; 
            background-color: #050505;
            background-image: 
                radial-gradient(circle at 5% 5%, rgba(10, 132, 255, 0.12) 0%, transparent 45%),
                radial-gradient(circle at 95% 95%, rgba(191, 90, 242, 0.12) 0%, transparent 45%);
        }

        /* LOGIN SCREEN STYLES */
        #login-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50000;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #050505;
            background-image: 
                radial-gradient(circle at 5% 5%, rgba(10, 132, 255, 0.12) 0%, transparent 45%),
                radial-gradient(circle at 95% 95%, rgba(191, 90, 242, 0.12) 0%, transparent 45%);
        }

        .login-card {
            width: 90%;
            max-width: 400px;
            padding: 40px;
            border-radius: var(--radius-card);
            text-align: center;
            border: 1px solid var(--glass-border);
            animation: fadeIn 0.5s ease-out;
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur));
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }

        .frosted {
            background: var(--glass-surface);
            backdrop-filter: blur(var(--blur)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur)) saturate(150%);
            border: 1px solid var(--glass-border);
        }

        .app-container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 40px;
            display: none;
            flex-direction: column;
        }

        .topbar {
            position: relative;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 32px;
            border-radius: var(--radius-card);
            margin-bottom: 40px;
            margin-top: 20px;
            transition: all 0.3s ease;
            background: var(--glass-surface);
        }

        .brand { display: flex; align-items: center; gap: 16px; }
        .brand-logo { height: 50px; width: auto; display: block; }
        .brand-text h1 {
            font-size: 1.25rem; font-weight: 800; margin: 0;
            background: var(--gradient-accent);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }

        .event-subtext { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .controls { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; align-items: center; }

        .control-item {
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: #fff;
            padding: 0 12px; border-radius: var(--radius-button); font-weight: 600; height: 38px;
            display: flex; align-items: center; cursor: pointer; transition: 0.2s; font-size: 0.75rem;
        }
        .control-item:hover { background: rgba(255,255,255,0.1); }
        .control-item.active { background: var(--gradient-accent); border: none; box-shadow: 0 8px 20px rgba(10, 132, 255, 0.2); }
        
        /* Filter specific colors */
        .control-item.active-review { background: var(--gradient-warning); border: none; color: #000; box-shadow: 0 8px 20px rgba(255, 149, 0, 0.2); }
        .control-item.active-approved { background: var(--gradient-success); border: none; box-shadow: 0 8px 20px rgba(52, 199, 89, 0.2); }
        .control-item.active-denied { background: var(--gradient-danger); border: none; box-shadow: 0 8px 20px rgba(255, 59, 48, 0.2); }
        .control-item.active-settings { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); }
        .control-item.active-profiles { background: #BF5AF2; border: none; box-shadow: 0 8px 20px rgba(191, 90, 242, 0.2); }

        .stats-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 20px; }
        .stat-card { padding: 24px; border-radius: var(--radius-card); text-align: center; transition: transform 0.3s ease; }
        .stat-val { font-size: 2.8rem; font-weight: 800; display: block; letter-spacing: -0.02em; }
        
        .stat-label { 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            color: var(--text-muted); 
            letter-spacing: 0.1em; 
            font-weight: 700; 
            display: block;
            margin-bottom: 10px;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; margin-bottom: 32px; }
        .table-container { margin-top: 20px; border-radius: var(--radius-card); overflow: hidden; overflow-x: auto; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 1000px; }
        th { padding: 16px; text-align: left; color: var(--text-muted); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; }
        th:last-child { text-align: right; }
        td { padding: 20px 16px; background: rgba(255, 255, 255, 0.03); border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); vertical-align: middle; }
        td:first-child { border-left: 1px solid var(--glass-border); border-top-left-radius: 16px; border-bottom-left-radius: 16px; }
        td:last-child { border-right: 1px solid var(--glass-border); border-top-right-radius: 16px; border-bottom-right-radius: 16px; }

        .clickable-row { cursor: pointer; transition: all 0.2s ease; }
        .clickable-row:hover td { background: rgba(255, 255, 255, 0.08); }

        .group-tag { font-size: 0.75rem; font-weight: 700; color: #BF5AF2; display: inline-block; text-transform: uppercase; background: rgba(191, 90, 242, 0.1); padding: 4px 8px; border-radius: 6px; }
        .power-tag { font-size: 0.75rem; font-weight: 700; color: #FFD60A; display: inline-block; text-transform: uppercase; background: rgba(255, 214, 10, 0.15); padding: 4px 8px; border-radius: 6px; margin-top: 4px; }
        
        .action-wrapper { display: flex; align-items: center; justify-content: flex-end; gap: 12px; }
        
        .status-badge { font-size: 0.75rem; font-weight: 800; padding: 6px 10px; border-radius: 6px; letter-spacing: 0.5px; text-transform: uppercase; display: inline-block; text-align: center; min-width: 80px;}
        .status-badge.sent { color: #34C759; background: rgba(52, 199, 89, 0.1); border: 1px solid rgba(52, 199, 89, 0.2); }
        .status-badge.draft { color: #FF9F0A; background: rgba(255, 159, 10, 0.1); border: 1px solid rgba(255, 159, 10, 0.2); }
        
        /* Interactive Status Toggle Styles */
        .status-toggle-group {
            display: inline-flex; 
            background: rgba(0,0,0,0.4); 
            border-radius: 8px; 
            border: 1px solid var(--glass-border); 
            overflow: hidden;
            white-space: nowrap;
        }

        .btn-quick-status {
            background: transparent;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            opacity: 0.3;
            filter: grayscale(100%);
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        .btn-quick-status:last-child { border-right: none; }
        .btn-quick-status:hover { opacity: 0.8; filter: grayscale(0%); background: rgba(255,255,255,0.05); transform: scale(1.05); }

        .btn-quick-status.active-approve { opacity: 1; filter: grayscale(0%); background: rgba(52, 199, 89, 0.2); box-shadow: inset 0 0 10px rgba(52, 199, 89, 0.1); }
        .btn-quick-status.active-review { opacity: 1; filter: grayscale(0%); background: rgba(255, 149, 0, 0.2); box-shadow: inset 0 0 10px rgba(255, 149, 0, 0.1); }
        .btn-quick-status.active-deny { opacity: 1; filter: grayscale(0%); background: rgba(255, 59, 48, 0.2); box-shadow: inset 0 0 10px rgba(255, 59, 48, 0.1); }

        .status-pill { font-size: 0.75rem; font-weight: 800; padding: 6px 12px; border-radius: 20px; text-transform: uppercase; display: inline-block; }
        .status-pill.review { background: var(--gradient-warning); color: #000; }
        .status-pill.approved { background: var(--gradient-success); color: #fff; }
        .status-pill.denied { background: var(--gradient-danger); color: #fff; }

        .btn-icon { background: transparent; border: none; cursor: pointer; font-size: 1.1rem; padding: 6px; opacity: 0.7; transition: 0.2s; color: white; border-radius: 8px; }
        .btn-icon:hover { opacity: 1; background: rgba(255,255,255,0.1); transform: scale(1.1); }
        
        .btn-action { 
            background: var(--gradient-accent); 
            border: none; 
            padding: 10px 20px; 
            border-radius: var(--radius-button); 
            color: #fff; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        .btn-action:active { transform: scale(0.96); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

        .modern-input { 
            width: 100%; 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid var(--glass-border); 
            padding: 12px 18px; 
            border-radius: var(--radius-input); 
            color: white; 
            outline: none; 
            font-size: 1rem; 
            transition: all 0.2s; 
            font-family: inherit;
        }
        
        select.modern-input {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px;
            padding-right: 40px;
            cursor: pointer;
            height: 50px;
        }
        
        select.modern-input option { background-color: #1a1a1a; color: white; }
        .modern-input:focus { border-color: #0A84FF; background: rgba(255, 255, 255, 0.08); }
        
        .form-card { padding: 40px; border-radius: var(--radius-card); max-width: 1000px; margin: 0 auto; }
        .editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .tag-chip { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; margin-bottom: 5px; }
        .tag-chip.bold-btn { border-color: #0A84FF; font-weight: 800; color: #0A84FF; }
        
        #emailPreview { background: #f4f4f4; border-radius: 12px; height: 500px; width: 100%; border: 1px solid #ccc; display: block; }

        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); 
            z-index: 10000; display: none; align-items: center; justify-content: center; 
            padding: 20px; overflow-y: auto; 
            transition: opacity 0.3s ease;
        }
        .modal-content { background: #111; border: 1px solid var(--glass-border); padding: 40px; border-radius: var(--radius-card); width: 100%; max-width: 900px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #fff; font-size: 2rem; cursor: pointer; line-height: 1; }

        #loader { position: fixed; bottom: 24px; right: 24px; background: rgba(20, 20, 20, 0.9); border: 1px solid var(--glass-border); border-radius: 50px; padding: 12px 20px; display: none; align-items: center; gap: 12px; z-index: 10000; backdrop-filter: blur(10px); font-weight: bold; }
        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.2); border-top-color: #0A84FF; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #toast { visibility: hidden; min-width: 300px; max-width: 90vw; background-color: rgba(15, 15, 15, 0.98); color: #fff; text-align: center; border-radius: 20px; padding: 25px; position: fixed; z-index: 20001; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.9); font-size: 1.2rem; font-weight: 800; border: 2px solid #34C759; box-shadow: 0 0 100px rgba(0,0,0,0.9); backdrop-filter: blur(12px); opacity: 0; transition: all 0.2s; pointer-events: none; }
        #toast.show { visibility: visible; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        
        .section-header { font-size: 0.9rem; font-weight: 800; color: #BF5AF2; text-transform: uppercase; margin-bottom: 15px; margin-top: 30px; letter-spacing: 0.05em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        
        .review-field-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; font-weight: 700; }
        .review-field-value { font-size: 1.1rem; color: #fff; margin-bottom: 20px; word-break: break-word; background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }

        @media (max-width: 900px) {
            .app-container { padding: 0 16px; }
            .topbar { flex-direction: column; gap: 16px; text-align: center; padding: 16px; margin-top: 10px; margin-bottom: 20px; }
            .brand { flex-direction: column; gap: 8px; }
            .brand-logo { height: 40px; } .brand-text h1 { font-size: 1.2rem; }
            .controls { flex-wrap: wrap; justify-content: center; width: 100%; gap: 6px; }
            .control-item { font-size: 0.75rem; padding: 0 10px; height: 36px; flex: 1 1 auto; justify-content: center; }
            .stats-container { grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
            .stat-card { padding: 16px; } .stat-val { font-size: 1.8rem; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px; position: relative; }
            td { border: none; padding: 6px 0; background: transparent; }
            td:first-child { border-radius: 0; padding-bottom: 8px; font-size: 1.2rem; font-weight: bold; border-left: none; }
            td:last-child { border-radius: 0; margin-top: 10px; display: block; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); border-right: none; }
            .action-wrapper { width: 100%; justify-content: space-between; }
            .editor-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="bg-container"></div>
<div id="loader"><div class="spinner"></div><span>LOADING</span></div>
<div id="toast">Notification</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
    <div class="login-card">
        <h2 style="margin-bottom: 10px; font-weight: 800;">MARKET ADMIN</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 30px;">Enter the system password to manage student vendors.</p>
        
        <div class="mb-4">
            <input type="password" id="login-password" class="modern-input" placeholder="Enter Password" style="text-align: center; font-family: inherit;">
            <p id="login-error" style="color: #FF3B30; font-size: 0.8rem; margin-top: 10px; font-weight: 600; display: none;">Invalid Password</p>
        </div>
        
        <button onclick="handleLogin()" class="btn-action" style="width: 100%; padding: 15px; font-size: 1rem;">LOG IN</button>
    </div>
</div>

<!-- REVIEW VENDOR MODAL (FULL APPLICATION RESPONSE) -->
<div id="reviewModal" class="modal-overlay" onclick="closeReviewModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closeReviewModal()">&times;</button>
        <h2 style="margin-top:0; margin-bottom:5px; font-weight: 800; font-size: 1.8rem;" id="reviewName">Vendor Name</h2>
        <div style="display:flex; gap:10px; margin-bottom: 20px;" id="reviewTags">
            <!-- Tags injected here -->
        </div>

        <div class="form-grid" style="margin-bottom: 20px;">
            <div>
                <div class="review-field-label">Student ID</div>
                <div class="review-field-value" id="reviewStudentId">-</div>
            </div>
            <div>
                <div class="review-field-label">Phone</div>
                <div class="review-field-value" id="reviewPhone">-</div>
            </div>
            <div>
                <div class="review-field-label">Preferred Email</div>
                <div class="review-field-value" id="reviewPrefEmail">-</div>
            </div>
            <div>
                <div class="review-field-label">GCU Email</div>
                <div class="review-field-value" id="reviewGcuEmail">-</div>
            </div>
        </div>

        <div class="review-field-label">Vendor / Project Description</div>
        <div class="review-field-value" id="reviewDesc" style="min-height: 80px; white-space: pre-wrap;">-</div>

        <div class="form-grid" style="margin-bottom: 20px;">
            <div>
                <div class="review-field-label">Comm Method</div>
                <div class="review-field-value" id="reviewCommMethod">-</div>
            </div>
            <div>
                <div class="review-field-label">Year / Major</div>
                <div class="review-field-value" id="reviewYear">-</div>
            </div>
            <div>
                <div class="review-field-label">Past Vendor?</div>
                <div class="review-field-value" id="reviewPastVendor">-</div>
            </div>
            <div>
                <div class="review-field-label">Stay Entire Event?</div>
                <div class="review-field-value" id="reviewAvailability">-</div>
            </div>
        </div>

        <div class="form-grid" style="margin-bottom: 20px;">
            <div>
                <div class="review-field-label">Food License?</div>
                <div class="review-field-value" id="reviewFoodLicense" style="font-weight:bold;">-</div>
            </div>
            <div>
                <div class="review-field-label">Food License File</div>
                <div class="review-field-value" id="reviewFoodLink">-</div>
            </div>
        </div>

        <div class="review-field-label">Social Media / Website</div>
        <div class="review-field-value" id="reviewLink" style="margin-bottom: 20px;">
            <a href="#" target="_blank" style="color: #0A84FF; text-decoration: none; font-weight: bold;">-</a>
        </div>

        <div class="review-field-label">Additional Comments</div>
        <div class="review-field-value" id="reviewComments" style="min-height: 40px; white-space: pre-wrap;">-</div>

        <div class="review-field-label">Agreements Checked</div>
        <div class="review-field-value" id="reviewAgreements" style="min-height: 40px; white-space: pre-wrap; font-family: monospace; font-size: 0.85rem; color: #a1a1aa;">-</div>

        <div class="review-field-label">Internal Notes (Admin Only)</div>
        <div style="margin-bottom: 20px; background: rgba(255,149,0,0.05); border: 1px solid rgba(255,149,0,0.2); padding: 15px; border-radius: 12px;">
            <textarea id="modalInternalNotes" class="modern-input" style="height: 80px; resize: vertical; margin-bottom: 10px; font-size: 0.95rem;" placeholder="Type private notes about this vendor here..."></textarea>
            <button type="button" class="btn-action" style="padding: 8px 16px; font-size: 0.85rem; background: #FF9500; color: #000;" onclick="saveInternalNotes()">üíæ Save Notes</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; border-top:1px solid rgba(255,255,255,0.1); padding-top:30px; gap: 15px;">
            <button type="button" class="btn-action" style="background:var(--gradient-danger); flex: 1; padding: 16px; font-size: 1.1rem;" onclick="processReview('Denied')">‚ùå DENY</button>
            <button type="button" class="btn-action" style="background:rgba(255,255,255,0.1); flex: 1; padding: 16px; font-size: 1.1rem;" onclick="processReview('Needs Review')">‚è≥ NEEDS REVIEW</button>
            <button type="button" class="btn-action" style="background:var(--gradient-success); flex: 1; padding: 16px; font-size: 1.1rem;" onclick="processReview('Approved')">‚úÖ APPROVE</button>
        </div>
    </div>
</div>

<!-- COMMENT MODAL (INTERNAL LOG) -->
<div id="commentModal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-content" style="max-width: 500px; padding: 30px;" onclick="event.stopPropagation()">
        <h3 id="commentModalTitle" style="margin-top:0; font-weight: 800; font-size: 1.4rem;">Require Comment</h3>
        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom: 20px;">Please enter a reason/note. This will be added to the internal notes.</p>
        <textarea id="commentModalText" class="modern-input" style="height: 120px; resize: none; font-family: inherit; font-size: 1rem;" placeholder="Type internal note here..."></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 20px;">
            <button class="btn-action" style="background:rgba(255,255,255,0.1);" onclick="resolveComment(null)">Cancel</button>
            <button class="btn-action" style="background:var(--gradient-accent);" onclick="resolveComment(document.getElementById('commentModalText').value)">Save & Continue</button>
        </div>
    </div>
</div>

<!-- EDIT VENDOR MODAL -->
<div id="editModal" class="modal-overlay" onclick="closeEditModal()" style="z-index: 10005;">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closeEditModal()">&times;</button>
        <h2 style="margin-top:0; margin-bottom:20px; font-weight: 800;">Edit Application</h2>
        
        <div class="form-grid" style="margin-bottom: 20px; gap: 16px;">
            <div>
                <label class="review-field-label">First Name</label>
                <input type="text" id="editFirstName" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Last Name</label>
                <input type="text" id="editLastName" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Student ID</label>
                <input type="text" id="editStudentId" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Phone</label>
                <input type="text" id="editPhone" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Preferred Email</label>
                <input type="text" id="editPrefEmail" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">GCU Email</label>
                <input type="text" id="editGcuEmail" class="modern-input">
            </div>
        </div>

        <div class="review-field-label">Vendor / Project Description</div>
        <textarea id="editDesc" class="modern-input" style="height: 80px; resize: vertical; margin-bottom: 20px;"></textarea>

        <div class="form-grid" style="margin-bottom: 20px; gap: 16px;">
            <div>
                <label class="review-field-label">Comm Method</label>
                <input type="text" id="editCommMethod" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Year / Major</label>
                <input type="text" id="editYear" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Past Vendor?</label>
                <input type="text" id="editPastVendor" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Stay Entire Event?</label>
                <input type="text" id="editAvailability" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Needs Power?</label>
                <select id="editNeedsPower" class="modern-input" style="padding-right: 40px;">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div>
                <label class="review-field-label">Social Media / Website</label>
                <input type="text" id="editLink" class="modern-input">
            </div>
        </div>

        <div class="form-grid" style="margin-bottom: 20px; gap: 16px;">
            <div>
                <label class="review-field-label">Food License? (Yes/No)</label>
                <input type="text" id="editFoodLicense" class="modern-input">
            </div>
            <div>
                <label class="review-field-label">Food License File Link</label>
                <input type="text" id="editFoodLink" class="modern-input" placeholder="https://...">
                <div id="editFoodImagePreview" style="margin-top: 10px; display: none;">
                    <img src="" style="max-width:100%; max-height:120px; border-radius:8px; border:1px solid rgba(255,255,255,0.2);">
                </div>
            </div>
        </div>

        <div class="form-grid" style="margin-bottom: 20px; gap: 16px;">
            <div>
                <label class="review-field-label">Additional Comments</label>
                <textarea id="editComments" class="modern-input" style="height: 100px; resize: vertical;"></textarea>
            </div>
            <div>
                <label class="review-field-label">Agreements Checked</label>
                <textarea id="editAgreements" class="modern-input" style="height: 100px; resize: vertical; font-family: monospace; font-size: 0.85rem; color:#aaa;"></textarea>
            </div>
        </div>

        <button onclick="saveVendorEdit()" class="btn-action" style="width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px;">üíæ Save Changes</button>
    </div>
</div>

<div class="app-container" id="main-app">
    <div class="frosted topbar">
        <div class="brand">
            <div class="brand-text">
                <h1>CAB Student Market</h1>
                <div class="event-subtext">Active: <select id="eventDropdown" class="modern-input" style="width:auto; height:36px; padding:0 36px 0 12px; display:inline-block; font-size:0.85rem;" onchange="switchEvent(this.value)"></select></div>
            </div>
        </div>
        <div class="controls">
            <button onclick="setFilter('inbox')" id="nav-inbox" class="control-item">üìã APPLICATIONS</button>
            <button onclick="setFilter('approved')" id="nav-approved" class="control-item">‚úÖ APPROVED</button>
            <button onclick="setFilter('review')" id="nav-review" class="control-item">‚è≥ NEEDS REVIEW</button>
            <button onclick="setFilter('power')" id="nav-power" class="control-item">‚ö° NEEDS POWER</button>
            <button onclick="setFilter('denied')" id="nav-denied" class="control-item">‚ùå DENIED</button>
            <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.2); margin: 0 2px;"></div>
            <button onclick="setFilter('profiles')" id="nav-profiles" class="control-item">üë§ PROFILES</button>
            <div style="width: 1px; height: 24px; background: rgba(255,255,255,0.2); margin: 0 2px;"></div>
            <button onclick="toggleView('settings')" id="nav-settings" class="control-item">‚öôÔ∏è SETTINGS</button>
        </div>
    </div>

    <!-- VIEW: MAIN LIST -->
    <div id="view-list" class="view">
        <div class="stats-container" id="statsBar">
            <div class="frosted stat-card"><span class="stat-label">New Apps</span><span class="stat-val" id="countInbox">0</span></div>
            <div class="frosted stat-card"><span class="stat-label">Needs Review</span><span class="stat-val" style="color:#FF9500" id="countReview">0</span></div>
            <div class="frosted stat-card"><span class="stat-label">Approved</span><span class="stat-val" style="color:#34C759" id="countApproved">0</span></div>
            <div class="frosted stat-card"><span class="stat-label">Denied</span><span class="stat-val" style="color:#FF3B30" id="countDenied">0</span></div>
        </div>

        <div style="display:flex; gap:12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
            <div style="display:flex; gap:12px; flex: 1; min-width: 300px;">
                <input type="text" id="search" class="modern-input" placeholder="Search name, email, or student ID..." onkeyup="renderTable()" style="flex:1;">
            </div>
            <div>
                <button onclick="sendBulkEmail()" id="blastBtn" class="btn-action" style="display: none;">üìß Email Unsent in Current View</button>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead><tr><th>App # / Student ID</th><th>Name</th><th>Pref Email</th><th>Status (Quick Set)</th><th>Email Sent?</th><th>Actions</th></tr></thead>
                <tbody id="vendorTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- VIEW: VENDOR PROFILES ARCHIVE -->
    <div id="view-profiles" class="view" style="display:none;">
        <div style="margin-bottom: 20px;">
            <h2 style="margin:0; font-weight: 800;">Vendor Profiles</h2>
            <p style="color:var(--text-muted); font-size: 0.95rem; margin-top: 5px;">Showing unique vendors from the last 5 months across all events.</p>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>Student ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Most Recent Application</th><th>Total Apps</th></tr></thead>
                <tbody id="profilesTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- VIEW: SETTINGS -->
    <div id="view-settings" class="view" style="display:none;">
        <div class="frosted form-card">
            <h2 class="mb-4">Market Setup</h2>
            
            <div style="margin-bottom:30px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 25px; border-radius: 20px;">
                <label class="stat-label" style="color: #BF5AF2; font-size: 1rem; margin-bottom: 20px;">Create New Market Event</label>
                
                <div class="form-grid" style="gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label class="stat-label">Student Market Name *</label>
                        <input type="text" id="evName" class="modern-input" placeholder="e.g. Spring 2026 Market">
                    </div>
                    <div>
                        <label class="stat-label">Location *</label>
                        <input type="text" id="evLocation" class="modern-input" placeholder="e.g. Prescott Field">
                    </div>
                </div>

                <div class="form-grid" style="gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label class="stat-label">Date of Market *</label>
                        <input type="date" id="evDate" class="modern-input">
                    </div>
                    <div>
                        <label class="stat-label">Time *</label>
                        <input type="text" id="evTime" class="modern-input" placeholder="e.g. 6:30-9:00pm">
                    </div>
                </div>

                <div class="form-grid" style="gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label class="stat-label">App Opens (Date/Time) *</label>
                        <input type="datetime-local" id="evOpen" class="modern-input">
                    </div>
                    <div>
                        <label class="stat-label">App Closes Deadline (Date/Time) *</label>
                        <input type="datetime-local" id="evClose" class="modern-input">
                    </div>
                </div>

                <div class="form-grid" style="gap: 20px; margin-bottom: 25px;">
                    <div>
                        <label class="stat-label">Vendor Contact Date *</label>
                        <input type="date" id="evContact" class="modern-input">
                    </div>
                    <div>
                        <label class="stat-label">Vendor Confirm Deadline *</label>
                        <input type="date" id="evConfirm" class="modern-input">
                    </div>
                </div>

                <button onclick="createNewEvent()" class="btn-action" style="width: 100%; padding: 15px; font-size: 1.1rem;">Create Event & Update Public Application Form</button>
            </div>
            
            <div style="margin-bottom:30px; padding: 20px; border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 16px; background: rgba(255, 59, 48, 0.05);">
                <label class="stat-label" style="color: #FF3B30;">Danger Zone</label>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong style="display:block; margin-bottom: 5px;">Delete Current Event</strong>
                        <span style="font-size: 0.8rem; color: var(--text-muted);">This will permanently remove the active market and all its applications.</span>
                    </div>
                    <button onclick="deleteCurrentEvent()" class="btn-action" style="background: var(--gradient-danger);">Delete Event</button>
                </div>
            </div>
            
            <hr style="border:0; border-top:1px solid var(--glass-border); margin:30px 0;">
            <div style="margin-bottom:30px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <label class="stat-label" style="margin-bottom:0;">Email Templates</label>
                    <select id="templateTypeSelector" class="modern-input" style="width:auto; height:40px; padding:0 36px 0 12px; margin:0;" onchange="switchTemplateType(this.value)">
                        <option value="approved">Approved Template</option>
                        <option value="power">Approved (With Power) Template</option>
                        <option value="denied">Denied Template</option>
                    </select>
                </div>
                
                <div class="form-grid" style="margin-bottom: 20px; gap: 16px;">
                    <div>
                        <label class="stat-label">Banner Image URL</label>
                        <input type="text" id="bannerUrlInput" class="modern-input" placeholder="Leave blank for no image..." oninput="updatePreview()">
                    </div>
                    <div>
                        <label class="stat-label">Email Heading</label>
                        <input type="text" id="headingTextInput" class="modern-input" placeholder="e.g. Market Status Update" oninput="updatePreview()">
                    </div>
                </div>

                <input type="text" id="emailSubjectInput" class="modern-input" placeholder="Subject Line" style="margin-bottom:12px; font-weight:bold;">
                <div class="editor-grid">
                    <div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
                            <button type="button" class="tag-chip bold-btn" onclick="insertTag('**Bold Text**')"><b>B</b> Bold</button>
                            <button type="button" class="tag-chip" onclick="insertTag('{{FIRST}}')">+ First Name</button>
                            <button type="button" class="tag-chip" onclick="insertTag('{{EVENT}}')">+ Event Name</button>
                        </div>
                        <textarea id="emailTemplateInput" class="modern-input" style="height:300px; font-family:sans-serif; font-size:0.95rem; line-height:1.5;" oninput="updatePreview()" placeholder="Type your message here..."></textarea>
                        <div style="display:flex; justify-content:space-between; margin-top:10px;">
                            <button onclick="resetTemplate()" style="background:transparent; border:1px solid rgba(255,255,255,0.3); color:#aaa; padding:8px 12px; border-radius:8px; cursor:pointer;">Reset Default</button>
                            <button onclick="saveEmailTemplate()" class="btn-action">Save Template</button>
                        </div>
                    </div>
                    <div>
                        <label class="stat-label" style="color:#aaa;">Full Email Preview</label>
                        <iframe id="emailPreview"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // SUPABASE SETUP
    const SUPABASE_URL = 'https://xdfbjusrwbxoxbcocxkp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_ylaFmuuSPD2UcKdF1yKw4g_UPXiRRef';
    
    let BREVO_API_KEY = '';
    const SENDER_EMAIL = 'noreply@cabgcu.com';
    const SENDER_NAME = 'Canyon Activities Board';

    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let currentData = { vendors: [], allEvents: [], activeId: "" };
    let realtimeSubscription = null;
    let currentTemplateType = 'approved';
    let activeFilter = 'inbox'; // inbox, review, approved, denied, power, profiles
    let currentReviewingId = null;
    let currentEditingId = null;
    let isInitialLoad = true;

    const DEFAULTS = {
        approved: { subj: "CAB Student Market: You're Approved!", body: "Hello {{FIRST}}!\n\nCongratulations, your application for {{EVENT}} has been **APPROVED**! üéâ\n\nWe are so excited to have you showcase your items at the market.\n\nMore details regarding setup time, maps, and rules will follow closer to the event date.\n\n‚Äì CAB Student Market Team" },
        power: { subj: "CAB Student Market: Approved (Power Access)", body: "Hello {{FIRST}}!\n\nCongratulations, your application for {{EVENT}} has been **APPROVED**! üéâ\n\nWe have noted your request for electricity and have secured a spot for you near a power source. Please ensure you bring your own extension cords.\n\nMore details will follow closer to the event date.\n\n‚Äì CAB Student Market Team" },
        denied: { subj: "CAB Student Market Application Update", body: "Hello {{FIRST}},\n\nThank you so much for applying to {{EVENT}}.\n\nUnfortunately, due to overwhelming demand and limited space, we are unable to accept your application at this time.\n\nWe highly encourage you to apply for our future markets!\n\n‚Äì CAB Student Market Team" }
    };

    // LOGIN LOGIC
    const SYSTEM_PASSWORD = "Cabgcu49!";

    function handleLogin() {
        const input = document.getElementById('login-password');
        const error = document.getElementById('login-error');
        
        if (input.value === SYSTEM_PASSWORD) {
            sessionStorage.setItem('cab_market_auth', 'true');
            unlockApp();
        } else {
            error.style.display = 'block';
            input.value = '';
            input.focus();
        }
    }

    async function unlockApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        
        // Fetch the API Key securely from Supabase
        const { data, error } = await _supabase.from('secrets').select('value').eq('name', 'BREVO_API_KEY').single();
        if (data && data.value) {
            BREVO_API_KEY = data.value.trim();
        } else {
            console.error("‚ö†Ô∏è Could not load API key", error);
        }

        refreshData();
        setupRealtime();
    }

    document.getElementById('login-password').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleLogin();
    });

    async function setupRealtime() {
        if (realtimeSubscription) _supabase.removeChannel(realtimeSubscription);
        realtimeSubscription = _supabase.channel('public:vendors')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'vendors' }, () => { refreshData(null, true); })
            .subscribe();
    }

    async function refreshData(eventId = null, silent = false) {
        if (!silent) document.getElementById('loader').style.display = 'flex';
        let activeId = eventId || localStorage.getItem('marketEventId');
        
        // Load Events
        const { data: eventsData, error: eventErr } = await _supabase.from('events').select('*');
        
        if (eventErr || !eventsData || eventsData.length === 0) {
            currentData.allEvents = [];
            currentData.activeId = null;
            document.getElementById('eventDropdown').innerHTML = '<option>No Active Markets</option>';
            document.getElementById('vendorTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center;">No events. Create one in Settings.</td></tr>';
            
            // Clear stats
            document.getElementById('countInbox').innerText = 0;
            document.getElementById('countReview').innerText = 0;
            document.getElementById('countApproved').innerText = 0;
            document.getElementById('countDenied').innerText = 0;

            toggleView('settings');
            showToast("No active markets. Please create one.");
            if (!silent) document.getElementById('loader').style.display = 'none';
            return;
        }

        let activeEvent = eventsData.find(e => e.id === activeId) || eventsData[0];
        activeId = activeEvent.id;
        localStorage.setItem('marketEventId', activeId);

        // Load Vendors for this event
        const { data: vendorsData, error: vendorErr } = await _supabase.from('vendors').select('*').eq('event_id', activeId).order('created_at', { ascending: false });
        
        if (vendorErr) {
            console.error("Error fetching vendors:", vendorErr);
        }

        // --- NEW LOGIC: Assign permanent application numbers based on submission order
        if (vendorsData) {
            const totalVendors = vendorsData.length;
            vendorsData.forEach((v, index) => {
                // Since we fetch newest first (descending), the item at the very end of the array is the oldest (#1)
                v.appNumber = totalVendors - index;
            });
        }

        currentData = {
            vendors: vendorsData || [],
            allEvents: eventsData,
            activeId: activeId,
            activeEventName: activeEvent.name || "Student Market",
            bannerUrl: activeEvent.banner_url || "",
            headingText: activeEvent.heading_text || "Market Status Update",
            
            apprSubj: activeEvent.template_approved_subject || DEFAULTS.approved.subj,
            apprBody: activeEvent.template_approved_body || DEFAULTS.approved.body,
            denSubj: activeEvent.template_denied_subject || DEFAULTS.denied.subj,
            denBody: activeEvent.template_denied_body || DEFAULTS.denied.body,
            powSubj: activeEvent.template_power_subject || DEFAULTS.power.subj,
            powBody: activeEvent.template_power_body || DEFAULTS.power.body
        };
        
        updateStats();
        
        const dropdown = document.getElementById('eventDropdown');
        if (dropdown) dropdown.innerHTML = currentData.allEvents.map(e => `<option value="${e.id}" ${e.id == currentData.activeId ? 'selected' : ''}>${e.name}</option>`).join('');
        
        loadTemplateToEditor();

        if (isInitialLoad && eventsData.length > 0) {
            setFilter('inbox');
            isInitialLoad = false;
        } else {
            if(activeFilter === 'profiles') {
                fetchAndRenderProfiles();
            } else if (document.getElementById('view-list').style.display !== 'none') {
                renderTable();
            }
        }
        
        if (!silent) document.getElementById('loader').style.display = 'none';
    }

    function updateStats() {
        // Count unprocessed applications (i.e. not sorted into one of the main 3 buckets)
        const inbox = currentData.vendors.filter(v => v.status !== 'Approved' && v.status !== 'Needs Review' && v.status !== 'Denied').length;
        const review = currentData.vendors.filter(v => v.status === 'Needs Review').length;
        const approved = currentData.vendors.filter(v => v.status === 'Approved').length;
        const denied = currentData.vendors.filter(v => v.status === 'Denied').length;

        document.getElementById('countInbox').innerText = inbox;
        document.getElementById('countReview').innerText = review;
        document.getElementById('countApproved').innerText = approved;
        document.getElementById('countDenied').innerText = denied;
    }

    function setFilter(filter) {
        activeFilter = filter;
        document.querySelectorAll('.control-item').forEach(el => el.classList.remove('active', 'active-review', 'active-approved', 'active-denied', 'active-settings', 'active-profiles'));
        
        const btn = document.getElementById(`nav-${filter}`);
        if(btn) {
            if (filter === 'inbox') btn.classList.add('active');
            else if (filter === 'review') btn.classList.add('active-review');
            else if (filter === 'approved') btn.classList.add('active-approved');
            else if (filter === 'denied') btn.classList.add('active-denied');
            else if (filter === 'power') btn.classList.add('active-power', 'active');
            else if (filter === 'profiles') btn.classList.add('active-profiles');
        }

        document.querySelectorAll('.view').forEach(e => e.style.display = 'none');
        
        if (filter === 'profiles') {
            document.getElementById('view-profiles').style.display = 'block';
            fetchAndRenderProfiles();
        } else {
            document.getElementById('view-list').style.display = 'block';
            renderTable();
        }
    }

    function toggleView(v) {
        if (v === 'settings') {
            document.querySelectorAll('.control-item').forEach(e => e.classList.remove('active', 'active-review', 'active-approved', 'active-denied', 'active-settings', 'active-profiles'));
            document.getElementById('nav-settings').classList.add('active-settings');
            document.querySelectorAll('.view').forEach(e => e.style.display = 'none');
            document.getElementById('view-settings').style.display = 'block';
        }
    }

    // VENDOR PROFILES LOGIC (Last 5 Months)
    async function fetchAndRenderProfiles() {
        document.getElementById('loader').style.display = 'flex';
        
        // Calculate date 5 months ago
        const fiveMonthsAgo = new Date();
        fiveMonthsAgo.setMonth(fiveMonthsAgo.getMonth() - 5);
        const isoDate = fiveMonthsAgo.toISOString();

        // Fetch all events to map their names
        let eventMap = {};
        if (currentData.allEvents && currentData.allEvents.length > 0) {
            currentData.allEvents.forEach(e => eventMap[e.id] = e.name);
        } else {
            const { data: allEvs } = await _supabase.from('events').select('id, name');
            if(allEvs) allEvs.forEach(e => eventMap[e.id] = e.name);
        }

        // Fetch vendors from the last 5 months
        const { data, error } = await _supabase.from('vendors')
            .select('*')
            .gte('created_at', isoDate)
            .order('created_at', { ascending: false });

        if (error) { 
            console.error(error); 
            document.getElementById('loader').style.display = 'none';
            return; 
        }

        // Group by email (case-insensitive) to create unique profiles
        const profilesMap = {};
        data.forEach(v => {
            const email = (v.preferred_email || '').toLowerCase().trim();
            if (!email) return;

            if (!profilesMap[email]) {
                profilesMap[email] = {
                    ...v,
                    appCount: 1,
                    lastEvent: eventMap[v.event_id] || 'Unknown Event'
                };
            } else {
                profilesMap[email].appCount++;
            }
        });

        const profiles = Object.values(profilesMap);
        
        const tbody = document.getElementById('profilesTableBody');
        if (profiles.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No vendor profiles found in the last 5 months.</td></tr>';
        } else {
            tbody.innerHTML = profiles.map(p => `
                <tr>
                    <td style="font-family: monospace; letter-spacing: 1px;">${p.student_id || 'N/A'}</td>
                    <td><strong>${p.first_name} ${p.last_name}</strong></td>
                    <td><a href="mailto:${p.preferred_email}" style="color:var(--text-muted);">${p.preferred_email}</a></td>
                    <td>${p.phone || 'N/A'}</td>
                    <td>${p.lastEvent}</td>
                    <td><span class="status-badge sent" style="background: rgba(191, 90, 242, 0.1); border-color: rgba(191, 90, 242, 0.3); color: #BF5AF2;">${p.appCount} Apps</span></td>
                </tr>
            `).join('');
        }
        document.getElementById('loader').style.display = 'none';
    }

    let commentResolver = null;
    function promptForComment(statusName) {
        return new Promise((resolve) => {
            document.getElementById('commentModalTitle').innerText = `Notes for: ${statusName}`;
            document.getElementById('commentModalText').value = '';
            document.getElementById('commentModal').style.display = 'flex';
            document.getElementById('commentModalText').focus();
            commentResolver = resolve;
        });
    }

    function resolveComment(val) {
        document.getElementById('commentModal').style.display = 'none';
        if (commentResolver) {
            commentResolver(val);
            commentResolver = null;
        }
    }

    // Handles the inline quick status change
    async function quickStatus(id, newStatus) {
        const vendor = currentData.vendors.find(v => v.id === id);
        if (!vendor) return false;
        
        let targetStatus = newStatus;
        
        // UNSELECT: If they click the same status that is already active, revert to Inbox/Pending
        if (vendor.status === newStatus) {
            targetStatus = 'Pending';
        }
        
        let updates = { status: targetStatus };

        // Enforce required internal comment for specific statuses
        if (targetStatus === 'Needs Review' || targetStatus === 'Denied') {
            const reason = await promptForComment(targetStatus);
            if (reason === null || reason.trim() === '') {
                showToast("Action cancelled: Comment is required.");
                return false;
            }
            
            // Format log entry
            const timestamp = new Date().toLocaleString();
            const formattedNote = `[${timestamp}] (${targetStatus}): ${reason.trim()}`;
            updates.internal_notes = vendor.internal_notes ? `${formattedNote}\n\n${vendor.internal_notes}` : formattedNote;
        }

        // Optimistic UI Update
        const oldStatus = vendor.status;
        const oldNotes = vendor.internal_notes;

        vendor.status = targetStatus;
        if (updates.internal_notes) {
            vendor.internal_notes = updates.internal_notes;
            // Update modal text area live if it's currently open
            const modalNotesEl = document.getElementById('modalInternalNotes');
            if (modalNotesEl && currentReviewingId === id) {
                modalNotesEl.value = vendor.internal_notes;
            }
        }
        
        updateStats();
        renderTable(); 
        
        // Background DB sync
        const { error } = await _supabase.from('vendors').update(updates).eq('id', id);
        if (error) {
            console.error(error);
            showToast("‚ö†Ô∏è Error updating status in database");
            // Revert on failure
            vendor.status = oldStatus;
            vendor.internal_notes = oldNotes;
            if (currentReviewingId === id) {
                const modalNotesEl = document.getElementById('modalInternalNotes');
                if (modalNotesEl) modalNotesEl.value = oldNotes || '';
            }
            refreshData(null, true);
            return false;
        }
        return true;
    }

    // Shared data cleaner to extract junk out of the Comments field
    function extractCleanData(vendor) {
        let rawComments = vendor.additional_comments || '';
        let cleanedComments = [];
        let parsedAgreements = [];

        rawComments.split('\n').forEach(line => {
            const trimmed = line.trim();
            if (!trimmed) return;

            if (trimmed.includes('Acknowledgment:')) {
                parsedAgreements.push(trimmed);
            } else if (trimmed.startsWith('First and Last Name:')) {
                // Ignore completely
            } else {
                cleanedComments.push(trimmed);
            }
        });

        let finalComments = cleanedComments.join('\n');
        
        let dbAgreements = vendor.agreements_checked || '';
        if (!dbAgreements && parsedAgreements.length > 0) {
            dbAgreements = parsedAgreements.join('\n');
        }

        return { finalComments, dbAgreements };
    }

    function renderTable() {
        const search = document.getElementById('search').value.toLowerCase();
        
        // Dynamically update the bulk email button based on the active tab
        const blastBtn = document.getElementById('blastBtn');
        if (activeFilter === 'approved') {
            blastBtn.style.display = 'block';
            blastBtn.innerText = 'üìß Send Approved Emails (Unsent)';
        } else if (activeFilter === 'denied') {
            blastBtn.style.display = 'block';
            blastBtn.innerText = 'üìß Send Denied Emails (Unsent)';
        } else if (activeFilter === 'power') {
            blastBtn.style.display = 'block';
            blastBtn.innerText = 'üìß Send Power Emails (Unsent)';
        } else {
            blastBtn.style.display = 'none';
        }
        
        let filtered = currentData.vendors.filter(v => {
            // Apply Tab Filter
            if (activeFilter === 'inbox' && (v.status === 'Approved' || v.status === 'Needs Review' || v.status === 'Denied')) return false;
            if (activeFilter === 'review' && v.status !== 'Needs Review') return false;
            if (activeFilter === 'approved' && v.status !== 'Approved') return false;
            if (activeFilter === 'denied' && v.status !== 'Denied') return false;
            
            // NEW POWER LOGIC: Only show Approved vendors who need power
            if (activeFilter === 'power' && (v.status !== 'Approved' || v.needs_power !== 'Yes')) return false;

            // Apply Search Filter
            if (search) {
                const searchStr = `${v.student_id} ${v.first_name} ${v.last_name} ${v.preferred_email} ${v.gcu_email}`.toLowerCase();
                if (!searchStr.includes(search)) return false;
            }
            return true;
        });

        const tbody = document.getElementById('vendorTableBody');
        
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px;">No applications found in this view.</td></tr>';
            return;
        }

        const generateRowHtml = (v) => {
            // Interactive status toggle UI
            const statusToggle = `
                <div class="status-toggle-group" onclick="event.stopPropagation()">
                    <button onclick="quickStatus('${v.id}', 'Approved')" class="btn-quick-status ${v.status === 'Approved' ? 'active-approve' : ''}" title="${v.status === 'Approved' ? 'Unselect Approved' : 'Mark as Approved'}">‚úÖ</button>
                    <button onclick="quickStatus('${v.id}', 'Needs Review')" class="btn-quick-status ${v.status === 'Needs Review' ? 'active-review' : ''}" title="${v.status === 'Needs Review' ? 'Unselect Needs Review' : 'Mark as Needs Review'}">‚è≥</button>
                    <button onclick="quickStatus('${v.id}', 'Denied')" class="btn-quick-status ${v.status === 'Denied' ? 'active-deny' : ''}" title="${v.status === 'Denied' ? 'Unselect Denied' : 'Mark as Denied'}">‚ùå</button>
                </div>
            `;

            const powerTag = v.needs_power === 'Yes' ? `<br><span class="power-tag">‚ö° Needs Power</span>` : '';
            const emailSentBadge = v.email_sent === 'Yes' ? `<span class="status-badge sent">‚úâÔ∏è SENT</span>` : `<span class="status-badge draft">‚ö†Ô∏è UNSENT</span>`;
            
            // Only show the individual email icon on valid tabs
            const canEmail = (activeFilter === 'approved' || activeFilter === 'denied' || activeFilter === 'power');

            return `
            <tr class="clickable-row" onclick="openReviewModal('${v.id}')">
                <td><span style="color: #BF5AF2; font-weight: 800; margin-right: 8px; font-size: 1.1rem;">#${v.appNumber}</span><br><span style="font-family: monospace; letter-spacing: 1px; font-size: 0.85rem; color: var(--text-muted);">${v.student_id || 'N/A'}</span></td>
                <td><strong>${v.first_name} ${v.last_name}</strong>${powerTag}</td>
                <td><a href="mailto:${v.preferred_email}" onclick="event.stopPropagation()" style="color:var(--text-muted);">${v.preferred_email}</a><br><small style="color:var(--text-muted); opacity: 0.5;">${v.gcu_email || ''}</small></td>
                <td>${statusToggle}</td>
                <td>${emailSentBadge}</td>
                <td>
                    <div class="action-wrapper" onclick="event.stopPropagation()">
                        <button onclick="openEditModal('${v.id}')" class="btn-icon" title="Edit Application">‚úèÔ∏è</button>
                        <button onclick="resendEmail('${v.id}')" class="btn-icon" title="Send Status Email" style="${canEmail ? '' : 'display:none;'}">üì©</button>
                        <button onclick="deleteVendor('${v.id}')" class="btn-icon" style="color:#FF3B30;" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
            `;
        };

        // Render naturally (no more nested groups since Power is only Approved now)
        tbody.innerHTML = filtered.map(v => generateRowHtml(v)).join('');
    }

    // REVIEW MODAL LOGIC (FULL RESPONSE)
    function openReviewModal(id) {
        const vendor = currentData.vendors.find(v => v.id === id);
        if (!vendor) return;
        
        currentReviewingId = id;
        document.getElementById('reviewName').innerText = `#${vendor.appNumber} - ${vendor.first_name} ${vendor.last_name}`;
        
        let tagsHtml = '';
        if (vendor.status === 'Needs Review') tagsHtml += `<span class="status-pill review" style="font-size: 0.85rem;">‚è≥ Needs Review</span>`;
        else if (vendor.status === 'Approved') tagsHtml += `<span class="status-pill approved" style="font-size: 0.85rem;">‚úÖ Approved</span>`;
        else if (vendor.status === 'Denied') tagsHtml += `<span class="status-pill denied" style="font-size: 0.85rem;">‚ùå Denied</span>`;
        
        if (vendor.needs_power === 'Yes') tagsHtml += `<span class="power-tag" style="margin-top:0; font-size: 0.85rem;">‚ö° Power Requested</span>`;
        
        document.getElementById('reviewTags').innerHTML = tagsHtml;

        // Core fields
        document.getElementById('reviewStudentId').innerText = vendor.student_id || 'N/A';
        document.getElementById('reviewPhone').innerText = vendor.phone || 'N/A';
        document.getElementById('reviewPrefEmail').innerText = vendor.preferred_email || 'N/A';
        document.getElementById('reviewGcuEmail').innerText = vendor.gcu_email || 'N/A';
        
        document.getElementById('reviewDesc').innerText = vendor.description || 'No description provided.';
        
        // Full Application Additional Fields
        document.getElementById('reviewCommMethod').innerText = vendor.communication_method || 'N/A';
        document.getElementById('reviewYear').innerText = vendor.year || 'N/A';
        document.getElementById('reviewPastVendor').innerText = vendor.past_vendor || 'N/A';
        document.getElementById('reviewAvailability').innerText = vendor.availability || 'N/A';
        
        // --- DATA CLEANER ---
        const cleanData = extractCleanData(vendor);
        document.getElementById('reviewComments').innerText = cleanData.finalComments || 'None';
        document.getElementById('reviewAgreements').innerText = cleanData.dbAgreements || 'None recorded';
        // --------------------

        // Food License Handling (Highlight Red if "No")
        const foodLicEl = document.getElementById('reviewFoodLicense');
        const foodVal = vendor.food_license || 'N/A';
        foodLicEl.innerText = foodVal;
        
        if (foodVal.toLowerCase().includes('no')) {
            foodLicEl.style.color = '#FF3B30';
            foodLicEl.style.textShadow = '0 0 10px rgba(255,59,48,0.3)';
        } else {
            foodLicEl.style.color = '#fff';
            foodLicEl.style.textShadow = 'none';
        }

        // Render File Link / Image Preview
        const fLinkEl = document.getElementById('reviewFoodLink');
        if (vendor.food_license_link) {
            fLinkEl.innerHTML = `
                <a href="${vendor.food_license_link}" target="_blank" style="color:#0A84FF; font-weight:bold; display:block; margin-bottom:8px;">Open File ‚Üó</a>
                <img src="${vendor.food_license_link}" style="max-width:100%; max-height:200px; border-radius:8px; border:1px solid rgba(255,255,255,0.2);" onerror="this.style.display='none'">
            `;
        } else {
            fLinkEl.innerHTML = `<span style="color:var(--text-muted);">N/A</span>`;
        }
        
        // Load Internal Notes into textarea
        document.getElementById('modalInternalNotes').value = vendor.internal_notes || '';

        const linkEl = document.getElementById('reviewLink');
        if (vendor.link) {
            let validUrl = vendor.link.startsWith('http') ? vendor.link : `https://${vendor.link}`;
            linkEl.innerHTML = `<a href="${validUrl}" target="_blank" style="color: #0A84FF; text-decoration: none; font-weight: bold;">${vendor.link} ‚Üó</a>`;
        } else {
            linkEl.innerHTML = `<span style="color:var(--text-muted);">No link provided</span>`;
        }

        document.getElementById('reviewModal').style.display = 'flex';
    }

    async function saveInternalNotes() {
        if (!currentReviewingId) return;
        const id = currentReviewingId;
        const notes = document.getElementById('modalInternalNotes').value;
        const vendor = currentData.vendors.find(v => v.id === id);
        
        if (vendor) vendor.internal_notes = notes;
        
        showToast("Saving note...");
        const { error } = await _supabase.from('vendors').update({ internal_notes: notes }).eq('id', id);
        if (error) {
            console.error(error);
            showToast("‚ö†Ô∏è Error saving note");
        } else {
            showToast("‚úÖ Note saved!");
        }
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
        currentReviewingId = null;
    }

    // EDIT MODAL LOGIC
    function openEditModal(id) {
        const vendor = currentData.vendors.find(v => v.id === id);
        if (!vendor) return;
        
        currentEditingId = id;
        
        document.getElementById('editFirstName').value = vendor.first_name || '';
        document.getElementById('editLastName').value = vendor.last_name || '';
        document.getElementById('editStudentId').value = vendor.student_id || '';
        document.getElementById('editPhone').value = vendor.phone || '';
        document.getElementById('editPrefEmail').value = vendor.preferred_email || '';
        document.getElementById('editGcuEmail').value = vendor.gcu_email || '';
        document.getElementById('editDesc').value = vendor.description || '';
        document.getElementById('editCommMethod').value = vendor.communication_method || '';
        document.getElementById('editYear').value = vendor.year || '';
        document.getElementById('editPastVendor').value = vendor.past_vendor || '';
        document.getElementById('editAvailability').value = vendor.availability || '';
        document.getElementById('editNeedsPower').value = vendor.needs_power === 'Yes' ? 'Yes' : 'No';
        document.getElementById('editLink').value = vendor.link || '';
        
        // Load Cleaned Comments & Food License
        const cleanData = extractCleanData(vendor);
        document.getElementById('editComments').value = cleanData.finalComments;
        document.getElementById('editAgreements').value = cleanData.dbAgreements;
        document.getElementById('editFoodLicense').value = vendor.food_license || '';
        
        const foodLinkInput = document.getElementById('editFoodLink');
        const foodImagePreview = document.getElementById('editFoodImagePreview');
        
        foodLinkInput.value = vendor.food_license_link || '';
        
        // Show Image Preview in Edit Modal if it exists
        if (vendor.food_license_link) {
            foodImagePreview.style.display = 'block';
            foodImagePreview.querySelector('img').src = vendor.food_license_link;
        } else {
            foodImagePreview.style.display = 'none';
            foodImagePreview.querySelector('img').src = '';
        }

        // Live update the image preview if admin pastes a new URL
        foodLinkInput.oninput = (e) => {
            const val = e.target.value;
            if (val.startsWith('http')) {
                foodImagePreview.style.display = 'block';
                foodImagePreview.querySelector('img').src = val;
            } else {
                foodImagePreview.style.display = 'none';
            }
        };

        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        currentEditingId = null;
    }

    async function saveVendorEdit() {
        if (!currentEditingId) return;
        
        const updates = {
            first_name: document.getElementById('editFirstName').value.trim(),
            last_name: document.getElementById('editLastName').value.trim(),
            student_id: document.getElementById('editStudentId').value.trim(),
            phone: document.getElementById('editPhone').value.trim(),
            preferred_email: document.getElementById('editPrefEmail').value.trim(),
            gcu_email: document.getElementById('editGcuEmail').value.trim(),
            description: document.getElementById('editDesc').value.trim(),
            communication_method: document.getElementById('editCommMethod').value.trim(),
            year: document.getElementById('editYear').value.trim(),
            past_vendor: document.getElementById('editPastVendor').value.trim(),
            availability: document.getElementById('editAvailability').value.trim(),
            needs_power: document.getElementById('editNeedsPower').value,
            link: document.getElementById('editLink').value.trim(),
            food_license: document.getElementById('editFoodLicense').value.trim(),
            food_license_link: document.getElementById('editFoodLink').value.trim(),
            additional_comments: document.getElementById('editComments').value.trim(),
            agreements_checked: document.getElementById('editAgreements').value.trim()
        };

        showToast("Saving edits...");
        const { error } = await _supabase.from('vendors').update(updates).eq('id', currentEditingId);
        
        if (error) {
            console.error(error);
            showToast("‚ö†Ô∏è Error saving edits");
        } else {
            showToast("‚úÖ Edits saved!");
            closeEditModal();
            refreshData(null, true);
        }
    }

    async function processReview(newStatus) {
        if (!currentReviewingId) return;
        const id = currentReviewingId;
        const vendor = currentData.vendors.find(v => v.id === id);
        
        // Check if unselecting
        const isUnselecting = vendor && vendor.status === newStatus;
        
        // Wait for quickStatus to finish properly before closing
        const success = await quickStatus(id, newStatus);
        
        if (success !== false) {
            closeReviewModal();
            showToast(isUnselecting ? `Reverted to Inbox` : `Marked as ${newStatus}`);
        }
    }

    async function deleteVendor(id) {
        if (confirm("Are you sure you want to permanently delete this application?")) {
            await _supabase.from('vendors').delete().eq('id', id);
            showToast("Deleted");
            refreshData(null, true);
        }
    }

    // EMAIL ENGINE
    function getTemplateDetails(vendor) {
        let subj = '', body = '';
        if (vendor.status === 'Approved') {
            if (vendor.needs_power === 'Yes') {
                subj = currentData.powSubj; body = currentData.powBody;
            } else {
                subj = currentData.apprSubj; body = currentData.apprBody;
            }
        } else if (vendor.status === 'Denied') {
            subj = currentData.denSubj; body = currentData.denBody;
        } else {
            return null; // Don't send emails to Needs Review
        }
        return { subj, body };
    }

    async function sendSingleEmail(vendor) {
        if (!vendor || !vendor.preferred_email || vendor.status === 'Needs Review' || vendor.status === 'Pending') return false;

        const templates = getTemplateDetails(vendor);
        if (!templates) return false;

        // Parse placeholders
        let rawBody = templates.body.replace(/\{\{FIRST\}\}/g, vendor.first_name || '')
                                  .replace(/\{\{EVENT\}\}/g, currentData.activeEventName || '');

        let htmlBodyStr = rawBody.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        let plainTextStr = rawBody.replace(/\*\*(.*?)\*\*/g, '$1');

        let parsedSubj = templates.subj.replace(/\{\{FIRST\}\}/g, vendor.first_name || '')
                                       .replace(/\{\{EVENT\}\}/g, currentData.activeEventName || '');

        const finalBannerUrl = currentData.bannerUrl || "";
        
        // HTML Builder
        const bannerHtml = finalBannerUrl ? `<tr><td align="center" style="padding: 0;"><img src="${finalBannerUrl}" alt="Banner" width="600" style="display: block; width: 100%; max-width: 100%; height: auto; border: 0;"></td></tr>` : "";
        
        let statusColor = vendor.status === 'Approved' ? '#34C759' : '#FF3B30';
        let statusBadge = vendor.status === 'Approved' ? 'APPROVED' : 'STATUS UPDATE';

        const htmlContent = `
        <!DOCTYPE html>
        <html lang="en">
        <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>
        <body style="margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif;">
            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="background-color: #f3f4f6;">
                <tr>
                    <td align="center" style="padding: 20px;">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px; background-color: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                            ${bannerHtml}
                            <tr>
                                <td align="center" style="background-color: #ffffff; padding: 40px 30px 20px 30px;">
                                    <h1 style="margin: 0; font-size: 24px; font-weight: 800; color: #111; text-transform: uppercase;">${currentData.headingText}</h1>
                                    <p style="margin: 12px 0 0 0; font-size: 12px; font-weight: 700; color: #fff; background-color: ${statusColor}; display: inline-block; padding: 6px 16px; text-transform: uppercase; letter-spacing: 1px; border-radius: 20px;">${statusBadge}</p>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 10px 40px 40px 40px; background-color: #ffffff; font-size: 16px; color: #333; line-height: 1.6;">
                                    ${htmlBodyStr}
                                </td>
                            </tr>
                            <tr>
                                <td align="center" style="background-color: #f9fafb; padding: 20px; border-top: 1px solid #eaeaea;">
                                    <p style="margin: 0; font-size: 12px; font-weight: 600; color: #aaa; text-transform: uppercase;">&copy; Canyon Activities Board</p>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </body>
        </html>`;

        const payload = {
            sender: { name: SENDER_NAME, email: SENDER_EMAIL },
            to: [{ email: vendor.preferred_email, name: `${vendor.first_name} ${vendor.last_name}`.trim() }],
            subject: parsedSubj,
            htmlContent: htmlContent,
            textContent: plainTextStr
        };
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch("https://api.brevo.com/v3/smtp/email", { 
                method: 'POST',
                headers: { 'accept': 'application/json', 'api-key': BREVO_API_KEY, 'content-type': 'application/json' },
                body: JSON.stringify(payload),
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                const errData = await response.json();
                console.error("Email API Error:", errData);
                return errData.code === 'unauthorized' ? 'unauthorized' : false;
            }
            
            // Mark Sent
            await _supabase.from('vendors').update({ email_sent: 'Yes' }).eq('id', vendor.id);
            return true;
        } catch (error) {
            console.error(`Failed to send to ${vendor.preferred_email}:`, error);
            return false;
        }
    }

    async function resendEmail(id) {
        if (activeFilter === 'inbox' || activeFilter === 'review') {
            showToast("Cannot send emails from this tab.");
            return;
        }
        
        const vendor = currentData.vendors.find(v => v.id === id);
        if (!vendor) return;
        if (vendor.status === 'Needs Review' || vendor.status === 'Pending') {
            showToast("Cannot email a pending application.");
            return;
        }
        
        showToast(`Sending to ${vendor.first_name}...`);
        const success = await sendSingleEmail(vendor);
        
        if (success === 'unauthorized') showToast("‚ö†Ô∏è API Error: Invalid Key.");
        else if (success) showToast("Sent!");
        else showToast("‚ö†Ô∏è Failed to send.");
        
        refreshData(null, true);
    }

    async function sendBulkEmail() { 
        if (activeFilter === 'inbox' || activeFilter === 'review') {
            alert("You cannot send emails from the Applications or Needs Review tabs. Please select Approved, Denied, or Needs Power.");
            return;
        }
        
        // Get vendors in CURRENT view that are NOT 'Needs Review', 'Pending', and NOT 'email_sent' = 'Yes'
        let targetVendors = currentData.vendors.filter(v => {
            if (v.status === 'Needs Review' || v.status === 'Pending' || v.email_sent === 'Yes') return false;
            
            if (activeFilter === 'approved' && v.status !== 'Approved') return false;
            if (activeFilter === 'denied' && v.status !== 'Denied') return false;
            if (activeFilter === 'power' && v.needs_power !== 'Yes') return false;
            return true;
        });

        if (targetVendors.length === 0) {
            alert("No eligible unsent vendors in this view. \n\nNote: You cannot send emails to 'Needs Review' status.");
            return;
        }
        
        if(!confirm(`You are about to send ${targetVendors.length} emails to the vendors in this list.\n\nThe system will automatically select the Approved, Denied, or Power template based on their status.\n\nClick OK to send!`)) return;
        
        let successCount = 0;
        let failCount = 0;
        let isUnauthorized = false;
        
        document.getElementById('loader').style.display = 'flex';
        const loaderText = document.querySelector('#loader span');
        
        const BATCH_SIZE = 10;
        for (let i = 0; i < targetVendors.length; i += BATCH_SIZE) {
            if (isUnauthorized) break;
            
            const batch = targetVendors.slice(i, i + BATCH_SIZE);
            const results = await Promise.all(batch.map(v => sendSingleEmail(v)));
            
            for (const success of results) {
                if (success === 'unauthorized') isUnauthorized = true;
                else if (success) successCount++;
                else failCount++;
            }
            loaderText.innerText = `SENDING ${Math.min(i + BATCH_SIZE, targetVendors.length)} / ${targetVendors.length}`;
        }
        
        document.getElementById('loader').style.display = 'none';
        loaderText.innerText = 'LOADING'; 
        
        if (isUnauthorized) alert(`‚ö†Ô∏è STOPPING: Email API Key is invalid.\n\n‚úÖ Sent: ${successCount}\n‚ö†Ô∏è Failed: ${failCount}`);
        else if (failCount > 0) alert(`Batch complete.\n\n‚úÖ Sent: ${successCount}\n‚ö†Ô∏è Failed: ${failCount}`);
        else showToast(`üöÄ All ${successCount} emails sent successfully!`); 
        
        refreshData(null, true); 
    }

    // SETTINGS / TEMPLATES
    function switchTemplateType(type) { currentTemplateType = type; loadTemplateToEditor(); }
    
    function loadTemplateToEditor() {
        const bodyInput = document.getElementById('emailTemplateInput');
        const subjInput = document.getElementById('emailSubjectInput');
        const bannerInput = document.getElementById('bannerUrlInput');
        const headingInput = document.getElementById('headingTextInput');

        if (!bodyInput || !subjInput) return;

        bannerInput.value = currentData.bannerUrl || "";
        headingInput.value = currentData.headingText || "";

        if (currentTemplateType === 'approved') { subjInput.value = currentData.apprSubj; bodyInput.value = currentData.apprBody; }
        else if (currentTemplateType === 'denied') { subjInput.value = currentData.denSubj; bodyInput.value = currentData.denBody; }
        else if (currentTemplateType === 'power') { subjInput.value = currentData.powSubj; bodyInput.value = currentData.powBody; }
        
        updatePreview();
    }

    function insertTag(t) { 
        const input = document.getElementById('emailTemplateInput'); 
        if (input) { 
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + t + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + t.length;
            updatePreview(); 
        } 
    }

    function resetTemplate() { 
        const type = currentTemplateType;
        if (DEFAULTS[type]) { 
            document.getElementById('emailTemplateInput').value = DEFAULTS[type].body; 
            document.getElementById('emailSubjectInput').value = DEFAULTS[type].subj; 
            updatePreview(); 
        }
    }

    function updatePreview() {
        const input = document.getElementById('emailTemplateInput');
        const previewIframe = document.getElementById('emailPreview');
        if (!input || !previewIframe) return;
        
        let text = input.value.replace(/\{\{FIRST\}\}/g, 'Alex')
                              .replace(/\{\{EVENT\}\}/g, currentData.activeEventName || 'Spring Market')
                              .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                              .replace(/\n/g, '<br>');
            
        const bannerUrl = document.getElementById('bannerUrlInput')?.value || "";
        const headingText = document.getElementById('headingTextInput')?.value || "Market Status Update";
        
        let statusColor = currentTemplateType === 'approved' || currentTemplateType === 'power' ? '#34C759' : '#FF3B30';
        let statusBadge = currentTemplateType === 'approved' || currentTemplateType === 'power' ? 'APPROVED' : 'STATUS UPDATE';

        const bannerHtml = bannerUrl ? `<tr><td align="center" style="padding: 0;"><img src="${bannerUrl}" alt="Banner" width="600" style="display: block; width: 100%; max-width: 100%; height: auto; border: 0;"></td></tr>` : "";

        previewIframe.srcdoc = `
        <body style="margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif;">
            <table border="0" cellpadding="0" cellspacing="0" width="100%" style="max-width: 600px; margin: 20px auto; background-color: #ffffff; border-radius: 16px; overflow: hidden;">
                ${bannerHtml}
                <tr>
                    <td align="center" style="padding: 30px;">
                        <h1 style="margin: 0; font-size: 20px; font-weight: 800; text-transform: uppercase;">${headingText}</h1>
                        <p style="margin: 10px 0 0 0; font-size: 11px; font-weight: 700; color: #fff; background-color: ${statusColor}; display: inline-block; padding: 4px 12px; text-transform: uppercase; border-radius: 12px;">${statusBadge}</p>
                    </td>
                </tr>
                <tr><td style="padding: 0 30px 30px 30px; font-size: 14px; color: #333; line-height: 1.6;">${text}</td></tr>
            </table>
        </body>`;
    }

    async function saveEmailTemplate() {
        const body = document.getElementById('emailTemplateInput').value;
        const subj = document.getElementById('emailSubjectInput').value;
        const banner = document.getElementById('bannerUrlInput').value;
        const heading = document.getElementById('headingTextInput').value;

        let updates = { banner_url: banner, heading_text: heading };
        
        if (currentTemplateType === 'approved') { updates.template_approved_body = body; updates.template_approved_subject = subj; }
        else if (currentTemplateType === 'denied') { updates.template_denied_body = body; updates.template_denied_subject = subj; }
        else if (currentTemplateType === 'power') { updates.template_power_body = body; updates.template_power_subject = subj; }
        
        await _supabase.from('events').update(updates).eq('id', currentData.activeId);
        showToast(`‚úÖ Template Saved!`);
        refreshData(null, true);
    }

    async function createNewEvent() { 
        const name = document.getElementById('evName').value.trim();
        const date = document.getElementById('evDate').value;
        const time = document.getElementById('evTime').value.trim();
        const location = document.getElementById('evLocation').value.trim();
        const open = document.getElementById('evOpen').value;
        const close = document.getElementById('evClose').value;
        const contact = document.getElementById('evContact').value;
        const confirm = document.getElementById('evConfirm').value;

        if(!name || !date || !time || !location || !open || !close || !contact || !confirm) {
            return alert("Please fill in all event details to create a new market.");
        }

        // Format dates nicely for text parsing
        const formatDate = (dStr) => {
            if(!dStr) return '';
            const d = new Date(dStr + 'T12:00:00'); // Force midday to avoid timezone shift
            return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        };
        const formatDateTime = (dtStr) => {
            if(!dtStr) return '';
            const d = new Date(dtStr);
            return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric' }) + ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        };

        const fDate = formatDate(date);
        const fContact = formatDate(contact);
        const fConfirm = formatDate(confirm);
        const fClose = formatDateTime(close);

        const apprBody = `Hello {{FIRST}}!\n\nCongratulations, your application for {{EVENT}} on ${fDate} has been **APPROVED**! üéâ\n\nWe are so excited to have you showcase your items at the market.\n\n**Please reply to this email to confirm your spot by ${fConfirm}.**\n\nMore details regarding setup time, maps, and rules will follow closer to the event date.\n\n‚Äì CAB Student Market Team`;
        
        const powBody = `Hello {{FIRST}}!\n\nCongratulations, your application for {{EVENT}} on ${fDate} has been **APPROVED**! üéâ\n\nWe have noted your request for electricity and have secured a spot for you near a power source. Please ensure you bring your own extension cords.\n\n**Please reply to this email to confirm your spot by ${fConfirm}.**\n\nMore details will follow closer to the event date.\n\n‚Äì CAB Student Market Team`;

        const { data, error } = await _supabase.from('events').insert([{ 
            name: name, 
            market_date: date,
            market_time: time,
            location: location,
            app_open: open,
            app_close: close,
            contact_date: contact,
            confirm_date: confirm,
            template_approved_body: apprBody, 
            template_approved_subject: DEFAULTS.approved.subj,
            template_denied_body: DEFAULTS.denied.body, 
            template_denied_subject: DEFAULTS.denied.subj,
            template_power_body: powBody, 
            template_power_subject: DEFAULTS.power.subj,
            banner_url: "", heading_text: "Market Status Update"
        }]).select(); 

        if(error) {
            if(error.message.includes("column")) {
                alert("Database Error: You need to run the provided SQL command in Supabase to add the new date/time columns to your 'events' table.");
            } else {
                alert("Error creating event.");
            }
            console.error(error);
            return;
        }

        if(data && data[0]) {
            // AUTOMATICALLY GENERATE PUBLIC APPLICATION FORM DESCRIPTION
            const newTitle = `${name} Vendor Application`;
            const newDesc = `Hello! Thank you for your interest in applying to a CAB student Market for the 2025-2026 school year! CAB Applications for the ${name}.<br><br><strong>Date of Market:</strong> ${fDate}<br><strong>Time:</strong> ${time}<br><strong>Location:</strong> ${location}<br><br>This application will close on ${fClose}.<br>Select vendors will be contacted via email on ${fContact}.<br>Respond to confirm your spot by ${fConfirm}.`;

            const { data: secData } = await _supabase.from('secrets').select('value').eq('name', 'MARKET_FORM_CONFIG_V3').maybeSingle();
            let configToSave = {};
            if (secData && secData.value) {
                configToSave = JSON.parse(secData.value);
            }
            
            configToSave.title = newTitle;
            configToSave.description = newDesc;

            await _supabase.from('secrets').upsert([
                { name: 'MARKET_FORM_CONFIG_V3', value: JSON.stringify(configToSave) }
            ], { onConflict: 'name' });

            // Reset UI Form
            document.querySelectorAll('#evName, #evDate, #evTime, #evLocation, #evOpen, #evClose, #evContact, #evConfirm').forEach(el => el.value = '');
            
            isInitialLoad = true; // force tab reset
            refreshData(data[0].id); 
            showToast("Market Created & App Updated!"); 
        }
    }

    async function deleteCurrentEvent() {
        const eventName = currentData.activeEventName || "Current Market";
        if (confirm(`‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\nAre you sure you want to completely delete "${eventName}"?\n\nThis will permanently erase all vendor applications associated with this event. THIS CANNOT BE UNDONE.`)) {
            showToast("Deleting market...");
            await _supabase.from('events').delete().eq('id', currentData.activeId);
            localStorage.removeItem('marketEventId');
            showToast("Market Deleted!");
            refreshData(null); 
        }
    }

    async function switchEvent(id) { await refreshData(id); }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    window.onload = () => { 
        if (sessionStorage.getItem('cab_market_auth') === 'true') {
            unlockApp();
        }
    };
</script>
</body>
</html>
